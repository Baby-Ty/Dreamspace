<!DOCTYPE html>
<html>
<head>
    <title>Debug Bruce Banner Coach Status</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; }
        .issue { background: #fff3cd; border-color: #ffeaa7; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { background: #ec4b5c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #d63547; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
        .result { color: green; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .problem { color: red; font-weight: bold; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üîç Debug Bruce Banner Coach Status</h1>
    <p>This tool will help diagnose why Bruce Banner sees "No Team Assigned" in the Dream Coach page.</p>
    
    <div class="section issue">
        <h3>üö® Current Issue</h3>
        <p><strong>Bruce Banner</strong> is signed in with Microsoft 365 but sees <strong>"No Team Assigned"</strong> on the Dream Coach page.</p>
        <p><strong>Expected:</strong> He should see his team members and coaching dashboard.</p>
    </div>

    <div class="section">
        <h3>Step 1: Check Bruce Banner's User Data</h3>
        <p>Let's see if Bruce exists in Cosmos DB and what his profile looks like.</p>
        <input type="text" id="bruceUserId" placeholder="Enter Bruce's User ID (e.g., bruce.banner@netsurit.com or GUID)" style="width: 400px; padding: 5px; margin: 5px;">
        <br>
        <button onclick="checkBruceProfile()">Check Bruce's Profile</button>
        <div id="profileLog" class="log"></div>
    </div>

    <div class="section">
        <h3>Step 2: Check All Team Relationships</h3>
        <p>Let's see what coaching relationships exist in the database.</p>
        <button onclick="checkAllTeams()">Get All Team Relationships</button>
        <div id="teamsLog" class="log"></div>
    </div>

    <div class="section">
        <h3>Step 3: Check Bruce's Team Metrics</h3>
        <p>Let's see if the getTeamMetrics API returns data for Bruce.</p>
        <button onclick="checkBruceTeamMetrics()">Check Bruce's Team Metrics</button>
        <div id="metricsLog" class="log"></div>
    </div>

    <div class="section">
        <h3>Step 4: Check All Users</h3>
        <p>Let's see all users in the system to understand the user ID format.</p>
        <button onclick="getAllUsers()">Get All Users</button>
        <div id="usersLog" class="log"></div>
    </div>

    <div class="section success" style="display:none;" id="solutionSection">
        <h3>üí° Solution</h3>
        <div id="solutionText"></div>
    </div>

    <script>
        const API_BASE = 'https://dreamspace.tylerstewart.co.za/api';
        let bruceUserData = null;
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'problem' : type === 'success' ? 'result' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        async function checkBruceProfile() {
            const logElement = 'profileLog';
            const userId = document.getElementById('bruceUserId').value.trim();
            
            if (!userId) {
                log(logElement, '‚ùå Please enter Bruce Banner\'s User ID', 'error');
                return;
            }
            
            document.getElementById(logElement).innerHTML = '';
            log(logElement, `üîç Checking profile for user: ${userId}`);
            
            try {
                const response = await fetch(`${API_BASE}/getUserData/${encodeURIComponent(userId)}`);
                
                if (response.ok) {
                    const userData = await response.json();
                    bruceUserData = userData;
                    log(logElement, '‚úÖ Bruce Banner found in database!', 'success');
                    log(logElement, `   Name: ${userData.name || 'Not set'}`);
                    log(logElement, `   Email: ${userData.email || 'Not set'}`);
                    log(logElement, `   Office: ${userData.office || 'Not set'}`);
                    log(logElement, `   Role: ${userData.role || 'Not set'}`);
                    log(logElement, `   Is Coach: ${userData.isCoach || false}`);
                    log(logElement, `   Score: ${userData.score || 0}`);
                } else if (response.status === 404) {
                    log(logElement, '‚ùå Bruce Banner NOT found in database', 'error');
                    log(logElement, '   This means he needs to be added to Cosmos DB first', 'warning');
                    showSolution('Bruce Banner is not in the Cosmos DB. He needs to be added as a user first, then promoted to coach.');
                } else {
                    const error = await response.json();
                    log(logElement, `‚ùå Error: ${error.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(logElement, `‚ùå Network Error: ${error.message}`, 'error');
            }
        }

        async function checkAllTeams() {
            const logElement = 'teamsLog';
            document.getElementById(logElement).innerHTML = '';
            log(logElement, 'üë• Fetching all team relationships...');
            
            try {
                const response = await fetch(`${API_BASE}/getTeamRelationships`);
                const result = await response.json();
                
                if (response.ok) {
                    const teams = result.teams || [];
                    log(logElement, `‚úÖ Found ${teams.length} teams:`, 'success');
                    
                    if (teams.length === 0) {
                        log(logElement, '‚ö†Ô∏è  No teams found in database!', 'warning');
                        showSolution('No coaching teams exist in the database. Bruce Banner needs to be promoted to coach or assigned a team.');
                        return;
                    }
                    
                    teams.forEach(team => {
                        log(logElement, `  üèÜ ${team.teamName || 'Unnamed Team'}`);
                        log(logElement, `     Coach ID: ${team.managerId}`);
                        log(logElement, `     Team Members: ${team.teamMembers?.length || 0}`);
                        log(logElement, `     Created: ${team.createdAt || 'Unknown'}`);
                        log(logElement, '');
                    });
                    
                    // Check if Bruce is a coach
                    const bruceUserId = document.getElementById('bruceUserId').value.trim();
                    if (bruceUserId) {
                        const bruceTeam = teams.find(team => 
                            team.managerId === bruceUserId || 
                            team.managerId === parseInt(bruceUserId) ||
                            team.managerId?.toString() === bruceUserId
                        );
                        
                        if (bruceTeam) {
                            log(logElement, `üéâ Bruce Banner IS a coach! Team: ${bruceTeam.teamName}`, 'success');
                        } else {
                            log(logElement, `‚ùå Bruce Banner is NOT a coach in any team`, 'error');
                            showSolution('Bruce Banner exists in the database but is not set up as a coach. He needs to be promoted to coach.');
                        }
                    }
                } else {
                    log(logElement, `‚ùå Error: ${result.error || 'Failed to get teams'}`, 'error');
                }
            } catch (error) {
                log(logElement, `‚ùå Network Error: ${error.message}`, 'error');
            }
        }

        async function checkBruceTeamMetrics() {
            const logElement = 'metricsLog';
            const userId = document.getElementById('bruceUserId').value.trim();
            
            if (!userId) {
                log(logElement, '‚ùå Please enter Bruce Banner\'s User ID first', 'error');
                return;
            }
            
            document.getElementById(logElement).innerHTML = '';
            log(logElement, `üìä Checking team metrics for Bruce (${userId})...`);
            
            try {
                const response = await fetch(`${API_BASE}/getTeamMetrics/${encodeURIComponent(userId)}`);
                
                if (response.ok) {
                    const metrics = await response.json();
                    log(logElement, '‚úÖ Team metrics found!', 'success');
                    log(logElement, `   Team Size: ${metrics.teamSize || 0}`);
                    log(logElement, `   Average Score: ${metrics.averageScore || 0}`);
                    log(logElement, `   Engagement Rate: ${metrics.engagementRate || 0}%`);
                    log(logElement, `   Team Members: ${metrics.teamMembers?.length || 0}`);
                    
                    if (metrics.teamMembers && metrics.teamMembers.length > 0) {
                        log(logElement, '   Team Member Details:');
                        metrics.teamMembers.forEach(member => {
                            log(logElement, `     - ${member.name} (${member.office}) - ${member.score || 0} pts`);
                        });
                    }
                } else if (response.status === 404) {
                    log(logElement, '‚ùå No team metrics found for Bruce', 'error');
                    log(logElement, '   This confirms Bruce is not set up as a coach', 'warning');
                } else {
                    const error = await response.json();
                    log(logElement, `‚ùå Error: ${error.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(logElement, `‚ùå Network Error: ${error.message}`, 'error');
            }
        }

        async function getAllUsers() {
            const logElement = 'usersLog';
            document.getElementById(logElement).innerHTML = '';
            log(logElement, 'üë§ Fetching all users to understand ID format...');
            
            try {
                const response = await fetch(`${API_BASE}/getAllUsers`);
                const result = await response.json();
                
                if (response.ok) {
                    const users = result.users || [];
                    log(logElement, `‚úÖ Found ${users.length} users:`, 'success');
                    
                    users.forEach(user => {
                        log(logElement, `  ${user.name || 'Unknown'} (ID: ${user.id}) - ${user.email || 'No email'} - ${user.office || 'No office'}`);
                        
                        // Check if this might be Bruce Banner
                        if (user.name?.toLowerCase().includes('bruce') || user.email?.toLowerCase().includes('bruce')) {
                            log(logElement, `  ‚≠ê This might be Bruce Banner! Try using ID: ${user.id}`, 'warning');
                            document.getElementById('bruceUserId').value = user.id;
                        }
                    });
                } else {
                    log(logElement, `‚ùå Error: ${result.error || 'Failed to get users'}`, 'error');
                }
            } catch (error) {
                log(logElement, `‚ùå Network Error: ${error.message}`, 'error');
            }
        }

        function showSolution(message) {
            document.getElementById('solutionSection').style.display = 'block';
            document.getElementById('solutionText').innerHTML = `
                <p><strong>Identified Issue:</strong> ${message}</p>
                <p><strong>Next Steps:</strong></p>
                <ol>
                    <li>If Bruce is not in the database: Use the setup tool to add him</li>
                    <li>If Bruce exists but is not a coach: Promote him using <code>/api/promoteUserToCoach</code></li>
                    <li>If Bruce is a coach but has no team members: Assign users to his team</li>
                    <li>Check Microsoft Entra ID roles - Bruce might need the "Coach" role assigned</li>
                </ol>
                <button onclick="window.open('setup-bruce-banner-coach.html', '_blank')">Open Setup Tool</button>
            `;
        }

        // Auto-suggest common user ID formats
        window.onload = () => {
            log('profileLog', 'üí° Common user ID formats to try:');
            log('profileLog', '   ‚Ä¢ bruce.banner@netsurit.com');
            log('profileLog', '   ‚Ä¢ Full name: "Bruce Banner"');
            log('profileLog', '   ‚Ä¢ GUID format (check "Get All Users" first)');
            log('profileLog', '');
            log('profileLog', 'üöÄ Start by clicking "Get All Users" to see the ID format used in your system');
        };
    </script>
</body>
</html>
