<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSpace Browser Test Runner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4A90E2 0%, #357abd 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
            text-align: center;
            transition: all 0.3s;
        }
        
        .status.pending {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }
        
        .status.running {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
            animation: pulse 1.5s infinite;
        }
        
        .status.pass {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }
        
        .status.fail {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }
        
        button:hover:not(:disabled) {
            background: #357abd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover:not(:disabled) {
            background: #5a6268;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover:not(:disabled) {
            background: #218838;
        }
        
        #results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', 'Consolas', monospace;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .test-item {
            padding: 10px;
            margin: 8px 0;
            border-left: 4px solid #ddd;
            padding-left: 15px;
            background: white;
            border-radius: 4px;
        }
        
        .test-item.pass {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .test-item.fail {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .test-item.warn {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .stat-card.pass h3 { color: #28a745; }
        .stat-card.fail h3 { color: #dc3545; }
        .stat-card.warn h3 { color: #ffc107; }
        .stat-card.skip h3 { color: #6c757d; }
        
        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #4A90E2;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .instructions h3 {
            color: #4A90E2;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin: 8px 0;
        }
        
        code {
            background: #f1f3f5;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }
        
        .phase-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .phase-btn {
            padding: 10px 20px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .phase-btn.active {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
        }
        
        .phase-btn:hover {
            background: #dee2e6;
        }
        
        .phase-btn.active:hover {
            background: #357abd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ DreamSpace Browser Test Runner</h1>
            <p>Automated Testing for DreamSpace Application</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>üìã Prerequisites</h3>
                <ol>
                    <li>Backend API running: <code>cd api && npm start</code></li>
                    <li>Frontend running: <code>npm run dev</code></li>
                    <li>DreamSpace open at <code>http://localhost:5173</code></li>
                    <li><strong>For Phase 2:</strong> User must be logged in</li>
                </ol>
            </div>

            <div class="phase-selector">
                <button class="phase-btn active" onclick="selectPhase('phase1')">Phase 1: Auth & Setup</button>
                <button class="phase-btn" onclick="selectPhase('phase2')">Phase 2: Core Features</button>
            </div>

            <div id="status" class="status pending">
                ‚è≥ Ready to run tests. Select a phase and click "Run Tests" below.
            </div>

            <div class="button-group">
                <button onclick="runTests()" id="runBtn">üöÄ Run Tests</button>
                <button onclick="clearResults()" class="secondary">üóëÔ∏è Clear Results</button>
                <button onclick="copyResults()" class="secondary">üìã Copy Results</button>
                <button onclick="openDreamSpace()" class="success">üåê Open DreamSpace</button>
            </div>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card pass">
                    <h3 id="passCount">0</h3>
                    <p>Passed</p>
                </div>
                <div class="stat-card fail">
                    <h3 id="failCount">0</h3>
                    <p>Failed</p>
                </div>
                <div class="stat-card warn">
                    <h3 id="warnCount">0</h3>
                    <p>Warnings</p>
                </div>
                <div class="stat-card skip">
                    <h3 id="skipCount">0</h3>
                    <p>Skipped</p>
                </div>
            </div>

            <div id="results"></div>
        </div>
    </div>

    <script>
        let currentPhase = 'phase1';
        let testWindow = null;

        function selectPhase(phase) {
            currentPhase = phase;
            document.querySelectorAll('.phase-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const statusEl = document.getElementById('status');
            if (phase === 'phase2') {
                statusEl.innerHTML = '‚ö†Ô∏è Phase 2 requires authentication. Make sure you are logged in to DreamSpace first.';
                statusEl.className = 'status pending';
            } else {
                statusEl.innerHTML = '‚è≥ Ready to run Phase 1 tests. Click "Run Tests" below.';
                statusEl.className = 'status pending';
            }
        }

        function openDreamSpace() {
            window.open('http://localhost:5173', '_blank');
        }

        async function runTests() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            const runBtn = document.getElementById('runBtn');
            const statsEl = document.getElementById('stats');
            
            statusEl.className = 'status running';
            statusEl.innerHTML = 'üîÑ Running tests... Please wait.';
            runBtn.disabled = true;
            resultsEl.innerHTML = '';
            statsEl.style.display = 'none';

            try {
                const scriptUrl = currentPhase === 'phase1' 
                    ? 'http://localhost:5173/scripts/browser-test-automation.js'
                    : 'http://localhost:5173/scripts/browser-test-phase2.js';
                
                const functionName = currentPhase === 'phase1'
                    ? 'dreamspaceTests.runAutomatedTests()'
                    : 'dreamspacePhase2Tests.runPhase2Tests()';

                // Try to load script in current window first
                if (window.location.origin === 'http://localhost:5173' || window.location.origin === 'file://') {
                    // We're on the DreamSpace page or local file
                    await loadAndRunScript(scriptUrl, functionName);
                } else {
                    // We need to open DreamSpace in a new window/tab
                    statusEl.innerHTML = 'üåê Opening DreamSpace... Please run tests in that window.';
                    
                    const instructions = `
                        <div style="padding: 20px; background: #e7f3ff; border-radius: 8px; margin: 20px 0;">
                            <h3>üìù Instructions:</h3>
                            <ol>
                                <li>DreamSpace should open in a new tab</li>
                                <li>Open DevTools (F12) ‚Üí Console tab</li>
                                <li>Paste this code:</li>
                            </ol>
                            <code style="display: block; padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 4px;">
const script = document.createElement('script');
script.src = '${scriptUrl}';
script.onload = () => ${functionName};
document.head.appendChild(script);
                            </code>
                            <p><strong>Or</strong> open this test runner from DreamSpace: <code>http://localhost:5173/browser-test-runner.html</code></p>
                        </div>
                    `;
                    
                    resultsEl.innerHTML = instructions;
                    openDreamSpace();
                }
            } catch (error) {
                statusEl.className = 'status fail';
                statusEl.innerHTML = `‚ùå Error: ${error.message}`;
                resultsEl.innerHTML = error.stack || error.message;
            } finally {
                runBtn.disabled = false;
            }
        }

        async function loadAndRunScript(scriptUrl, functionName) {
            return new Promise((resolve, reject) => {
                // Check if script already loaded
                const existingScript = document.querySelector(`script[src="${scriptUrl}"]`);
                if (existingScript && (window.dreamspaceTests || window.dreamspacePhase2Tests)) {
                    runTestFunction(functionName);
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = scriptUrl;
                script.onerror = () => {
                    reject(new Error(`Failed to load script from ${scriptUrl}. Make sure DreamSpace is running at http://localhost:5173`));
                };
                
                script.onload = () => {
                    setTimeout(() => {
                        runTestFunction(functionName);
                        resolve();
                    }, 500);
                };
                
                document.head.appendChild(script);
            });
        }

        function runTestFunction(functionName) {
            const resultsEl = document.getElementById('results');
            const statusEl = document.getElementById('status');
            const statsEl = document.getElementById('stats');
            
            // Capture console output
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            let output = '';

            console.log = (...args) => {
                const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                output += msg + '\n';
                originalLog.apply(console, args);
            };

            console.error = (...args) => {
                const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                output += msg + '\n';
                originalError.apply(console, args);
            };

            console.warn = (...args) => {
                const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
                output += msg + '\n';
                originalWarn.apply(console, args);
            };

            try {
                // Execute test function
                let testFunction;
                if (currentPhase === 'phase1') {
                    testFunction = window.dreamspaceTests?.runAutomatedTests;
                } else {
                    testFunction = window.dreamspacePhase2Tests?.runPhase2Tests;
                }

                if (!testFunction) {
                    throw new Error(`Test function not found. Make sure script loaded correctly.`);
                }

                testFunction().then(results => {
                    // Restore console
                    console.log = originalLog;
                    console.error = originalError;
                    console.warn = originalWarn;

                    // Display results
                    resultsEl.innerHTML = output || 'No output captured';
                    
                    // Update stats
                    if (results) {
                        document.getElementById('passCount').textContent = results.passed?.length || 0;
                        document.getElementById('failCount').textContent = results.failed?.length || 0;
                        document.getElementById('warnCount').textContent = results.warnings?.length || 0;
                        document.getElementById('skipCount').textContent = results.skipped?.length || 0;
                        statsEl.style.display = 'grid';
                    }
                    
                    // Update status
                    if (results && results.failed && results.failed.length === 0) {
                        statusEl.className = 'status pass';
                        statusEl.innerHTML = `‚úÖ All tests passed! (${results.passed?.length || 0} tests)`;
                    } else if (results && results.failed && results.failed.length > 0) {
                        statusEl.className = 'status fail';
                        statusEl.innerHTML = `‚ùå ${results.failed.length} test(s) failed. ${results.passed?.length || 0} passed.`;
                    } else {
                        statusEl.className = 'status pass';
                        statusEl.innerHTML = '‚úÖ Tests completed!';
                    }
                }).catch(err => {
                    console.log = originalLog;
                    console.error = originalError;
                    console.warn = originalWarn;
                    throw err;
                });
            } catch (error) {
                console.log = originalLog;
                console.error = originalError;
                console.warn = originalWarn;
                throw error;
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('status').className = 'status pending';
            document.getElementById('status').innerHTML = '‚è≥ Ready to run tests. Select a phase and click "Run Tests" below.';
            document.getElementById('stats').style.display = 'none';
        }

        function copyResults() {
            const results = document.getElementById('results').innerText;
            if (!results) {
                alert('No results to copy. Run tests first.');
                return;
            }
            navigator.clipboard.writeText(results).then(() => {
                alert('‚úÖ Results copied to clipboard!');
            }).catch(() => {
                alert('‚ùå Failed to copy. Please select and copy manually.');
            });
        }

        // Auto-detect if we're on DreamSpace domain
        if (window.location.hostname === 'localhost' && window.location.port === '5173') {
            document.getElementById('status').innerHTML = '‚úÖ Connected to DreamSpace. Ready to run tests!';
        }
    </script>
</body>
</html>

