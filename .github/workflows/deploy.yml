name: Deploy & Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build production
      run: npm run build
      env:
        VITE_APP_ENV: production

    - name: ğŸš€ Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "/"
        api_location: "api"
        output_location: "dist"
        skip_app_build: true  # We already built above

  smoke-test:
    name: Smoke Tests
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: â³ Wait for deployment
      run: sleep 30  # Give deployment time to propagate

    - name: ğŸ§ª Run smoke tests
      run: node scripts/smokeTest.cjs https://dreamspace.tylerstewart.co.za
      continue-on-error: false  # Fail workflow if tests fail

    - name: âœ… Tests passed
      if: success()
      run: echo "âœ… All smoke tests passed!"

    - name: âŒ Tests failed
      if: failure()
      run: |
        echo "âŒ Smoke tests failed!"
        echo "Check the logs above for details."
        exit 1

